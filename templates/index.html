<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Cookie Clicker</title>
    <style>
      body { font-family: system-ui, sans-serif; margin: 2rem; }
      button { padding: 0.5rem 1rem; font-size: 1rem; }
      input { padding: 0.5rem; margin-right: 1rem; }
      #shop { margin-top: 2rem; }
      .item { margin-bottom: 1rem; }
    </style>
  </head>
  <body>
    <h1>Cookie Clicker</h1>
    <p>Welcome, {{ session['username'] }}! <a href="/logout">Logout</a></p>

    <div>
      <h2>Saves</h2>
      <select id="saves"></select>
      <button id="load-save">Load Save</button>
      <button id="new-save">New Save</button>
      <button id="delete-save">Delete Save</button>
    </div>

    <p>Cookies: <strong id="count">0</strong></p>
    <button id="click">+1 Cookie</button>

    <div id="shop">
      <h2>Shop</h2>
      <div id="items"></div>
    </div>

    <script>
      const countEl = document.getElementById('count');
      const clickBtn = document.getElementById('click');
      const savesEl = document.getElementById('saves');
      const loadSaveBtn = document.getElementById('load-save');
      const newSaveBtn = document.getElementById('new-save');
      const deleteSaveBtn = document.getElementById('delete-save');
      const itemsEl = document.getElementById('items');

      let currentSave = null;
      let localClicks = 0;

      async function handleApi(url, options) {
        try {
          const res = await fetch(url, options);
          if (!res.ok) {
            const error = await res.text();
            throw new Error(error);
          }
          return res.json();
        } catch (err) {
          alert(err.message);
        }
      }

      async function getSaves() {
        const saves = await handleApi('/api/saves');
        savesEl.innerHTML = '';
        for (const save of saves) {
          const option = document.createElement('option');
          option.value = save.id;
          option.textContent = save.save_name;
          savesEl.appendChild(option);
        }
      }

      async function loadSave() {
        const saveId = savesEl.value;
        if (!saveId) return;

        const save = await handleApi(`/api/saves/${saveId}`);
        currentSave = save;
        countEl.textContent = save.cookies;
        localClicks = 0;
      }

      async function newSave() {
        const saveName = prompt('Enter a name for your new save:');
        if (!saveName) return;

        await handleApi('/api/saves', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ save_name: saveName }),
        });
        await getSaves();
      }

      async function deleteSave() {
        const saveId = savesEl.value;
        if (!saveId) return;

        if (confirm('Are you sure you want to delete this save?')) {
          await handleApi(`/api/saves/${saveId}`, { method: 'DELETE' });
          await getSaves();
        }
      }

      function increment() {
        if (!currentSave) return;
        localClicks++;
        countEl.textContent = parseInt(countEl.textContent) + 1;
      }

      async function sendClicks() {
        if (!currentSave || localClicks === 0) return;

        const data = await handleApi('/api/clicks', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ save_id: currentSave.id, clicks: localClicks }),
        });
        if (data && data.cookies !== undefined) {
          countEl.textContent = data.cookies;
        }
        localClicks = 0;
      }

      async function getItems() {
        const items = await handleApi('/api/items');
        itemsEl.innerHTML = '';
        for (const item of items) {
          const div = document.createElement('div');
          div.classList.add('item');
          div.innerHTML = `
            <strong>${item.name}</strong> - ${item.cost} cookies
            <button data-id="${item.id}" data-cost="${item.cost}">Buy</button>
          `;
          itemsEl.appendChild(div);
        }
      }

      async function buyItem(e) {
        if (!e.target.matches('button')) return;
        if (!currentSave) return;

        const itemId = e.target.dataset.id;
        const cost = parseInt(e.target.dataset.cost);
        if (parseInt(countEl.textContent) < cost) {
          alert('Not enough cookies!');
          return;
        }

        await handleApi('/api/buy', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ item_id: itemId, save_id: currentSave.id }),
        });
        await loadSave();
      }

      loadSaveBtn.addEventListener('click', loadSave);
      newSaveBtn.addEventListener('click', newSave);
      deleteSaveBtn.addEventListener('click', deleteSave);
      clickBtn.addEventListener('click', increment);
      itemsEl.addEventListener('click', buyItem);

      setInterval(sendClicks, 15000);

      getSaves();
      getItems();
    </script>
  </body>
</html>
