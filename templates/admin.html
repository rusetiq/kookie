<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Admin Panel</title>
    <style>
      body { font-family: system-ui, sans-serif; margin: 2rem; }
      table { border-collapse: collapse; width: 100%; }
      th, td { border: 1px solid #ddd; padding: 8px; }
      th { background-color: #f2f2f2; }
      .modal { display: none; position: fixed; z-index: 1; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4); }
      .modal-content { background-color: #fefefe; margin: 15% auto; padding: 20px; border: 1px solid #888; width: 80%; }
      .close { color: #aaa; float: right; font-size: 28px; font-weight: bold; }
      .close:hover, .close:focus { color: black; text-decoration: none; cursor: pointer; }
    </style>
  </head>
  <body>
    <h1>Admin Panel</h1>
    <p>Welcome, {{ session['username'] }}! <a href="/logout">Logout</a></p>

    <h2>Players</h2>
    <table id="players">
      <thead>
        <tr>
          <th>Username</th>
          <th>Saves</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <h2>Items</h2>
    <table id="items">
      <thead>
        <tr>
          <th>Name</th>
          <th>Cost</th>
          <th>Effect</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <button id="add-item">Add Item</button>

    <!-- Add/Edit Item Modal -->
    <div id="item-modal" class="modal">
      <div class="modal-content">
        <span class="close">&times;</span>
        <h2 id="item-modal-title">Add Item</h2>
        <form id="item-form">
          <input type="hidden" id="item-id" />
          <label for="item-name">Name:</label>
          <input type="text" id="item-name" required />
          <label for="item-cost">Cost:</label>
          <input type="number" id="item-cost" required />
          <label for="item-effect">Effect (JSON):</label>
          <textarea id="item-effect" required></textarea>
          <button type="submit">Save</button>
        </form>
      </div>
    </div>

    <!-- Edit Player Modal -->
    <div id="player-modal" class="modal">
      <div class="modal-content">
        <span class="close">&times;</span>
        <h2>Edit Player</h2>
        <form id="player-form">
          <input type="hidden" id="player-id" />
          <h3>Saves</h3>
          <div id="player-saves"></div>
          <button type="submit">Save</button>
        </form>
      </div>
    </div>

    <script>
      const itemModal = document.getElementById('item-modal');
      const playerModal = document.getElementById('player-modal');
      const itemModalTitle = document.getElementById('item-modal-title');
      const itemForm = document.getElementById('item-form');
      const playerForm = document.getElementById('player-form');
      const playerSaves = document.getElementById('player-saves');

      async function getPlayers() {
        const res = await fetch('/admin/api/players');
        const players = await res.json();
        const tbody = document.querySelector('#players tbody');
        tbody.innerHTML = '';
        for (const player of players) {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${player.username}</td>
            <td>${player.saves.length}</td>
            <td>
              <button data-id="${player.id}" class="edit-player">Edit</button>
            </td>
          `;
          tbody.appendChild(tr);
        }
      }

      async function getItems() {
        const res = await fetch('/admin/api/items');
        const items = await res.json();
        const tbody = document.querySelector('#items tbody');
        tbody.innerHTML = '';
        for (const item of items) {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${item.name}</td>
            <td>${item.cost}</td>
            <td>${JSON.stringify(item.effect)}</td>
            <td>
              <button data-id="${item.id}" class="edit-item">Edit</button>
              <button data-id="${item.id}" class="delete-item">Delete</button>
            </td>
          `;
          tbody.appendChild(tr);
        }
      }

      function openModal(modal) {
        modal.style.display = 'block';
      }

      function closeModal(modal) {
        modal.style.display = 'none';
      }

      document.addEventListener('click', async (e) => {
        if (e.target.matches('.edit-player')) {
          const playerId = e.target.dataset.id;
          const res = await fetch(`/admin/api/players/${playerId}`);
          const player = await res.json();
          document.getElementById('player-id').value = player.id;
          playerSaves.innerHTML = '';
          for (const save of player.saves) {
            playerSaves.innerHTML += `
              <div>
                <label for="save-${save.id}">${save.save_name}:</label>
                <input type="number" id="save-${save.id}" value="${save.cookies}" />
              </div>
            `;
          }
          openModal(playerModal);
        } else if (e.target.matches('.delete-item')) {
          const itemId = e.target.dataset.id;
          if (confirm('Are you sure you want to delete this item?')) {
            await fetch(`/admin/api/items/${itemId}`, { method: 'DELETE' });
            await getItems();
          }
        } else if (e.target.matches('#add-item')) {
          itemModalTitle.textContent = 'Add Item';
          itemForm.reset();
          openModal(itemModal);
        } else if (e.target.matches('.edit-item')) {
          const itemId = e.target.dataset.id;
          const res = await fetch(`/admin/api/items/${itemId}`);
          const item = await res.json();
          itemModalTitle.textContent = 'Edit Item';
          document.getElementById('item-id').value = item.id;
          document.getElementById('item-name').value = item.name;
          document.getElementById('item-cost').value = item.cost;
          document.getElementById('item-effect').value = JSON.stringify(item.effect);
          openModal(itemModal);
        } else if (e.target.matches('.close')) {
          closeModal(itemModal);
          closeModal(playerModal);
        }
      });

      itemForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const id = document.getElementById('item-id').value;
        const url = id ? `/admin/api/items/${id}` : '/admin/api/items';
        const method = id ? 'PUT' : 'POST';
        const body = {
          name: document.getElementById('item-name').value,
          cost: parseInt(document.getElementById('item-cost').value),
          effect: JSON.parse(document.getElementById('item-effect').value),
        };
        await fetch(url, {
          method,
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body),
        });
        await getItems();
        closeModal(itemModal);
      });

      playerForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const playerId = document.getElementById('player-id').value;
        const saves = [];
        for (const input of playerSaves.querySelectorAll('input')) {
          saves.push({
            id: input.id.replace('save-', ''),
            cookies: parseInt(input.value),
          });
        }
        await fetch(`/admin/api/players/${playerId}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ saves }),
        });
        closeModal(playerModal);
      });

      getPlayers();
      getItems();
    </script>
  </body>
</html>
